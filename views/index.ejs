<%- include('partials/header', { title: title }) %>

<main class="home-page">
  <div class="container">

    <div class="top-bar">
      <h1 class="page-title">üì∞ Latest Blog Posts</h1>
      <button id="themeToggle" class="theme-btn">
        üåô Dark Mode
      </button>
    </div>

    <% if (posts.length === 0) { %>
      <div class="no-posts">
        <p>No posts yet! Be the first to <a href="/compose">create one</a>.</p>
      </div>
    <% } else { %>
      <div class="posts-grid" id="postsGrid">
        <% posts.forEach(function(post, index) { %>
          <article class="post-card" style="<%= index >= 6 ? 'display:none;' : '' %>">
            <div class="post-thumbnail-container">
              <a href="/posts/<%= post._id %>">
                <img src="<%= post.coverImage %>" 
                     alt="<%= post.title %> cover image" 
                     class="post-thumbnail">
              </a>

              <!-- üßë‚Äçüíª Author Meta -->
              <div class="author-meta">
                <i class="fa-solid fa-user-pen"></i>
                <span>Published by</span>
                <a href="/users/<%= post.author._id %>" class="author-link">
                  <%= post.author.username %>
                </a>
              </div>
            </div>

            <div class="post-body">
              <h2 class="post-title">
                <a href="/posts/<%= post._id %>"><%= post.title %></a>
              </h2>

              <p class="post-date">
                <i class="fa-regular fa-calendar"></i> 
                <%= post.createdAt.toDateString() %>
              </p>

              <p class="post-snippet"><%= post.snippet %></p>

              <div class="post-actions">
                <a href="/posts/<%= post._id %>" class="btn read-btn">Read More</a>

                <% if (currentUser && currentUser._id.toString() === post.author._id.toString()) { %>
                  <!-- Only show edit/delete if current user is the author -->
                  <a href="/posts/<%= post._id %>/edit?_method=PUT" class="btn edit-btn">Edit</a>

                  <form action="/posts/<%= post._id %>?_method=DELETE" method="POST" class="delete-form">
                    <button type="submit" class="btn delete-btn"
                      onclick="return confirm('Are you sure you want to delete this post?');">
                      Delete
                    </button>
                  </form>
                <% } %>
              </div>
            </div>
          </article>
        <% }); %>
      </div>

      <% if (posts.length > 6) { %>
        <div class="load-more-container">
          <button id="loadMoreBtn" class="load-more-btn">Load More ‚Üì</button>
        </div>
      <% } %>
    <% } %>
  </div>
</main>

<%- include('partials/footer') %>

<style>
/* ===========================================
   GLOBAL STYLES
=========================================== */
body {
  background-color: var(--bg-color);
  color: var(--text-color);
  font-family: "Poppins", sans-serif;
  transition: all 0.4s ease;
}

:root {
  --bg-color: #fafafa;
  --card-bg: #fff;
  --text-color: #222;
  --border-color: #e0e0e0;
  --shadow-color: rgba(0,0,0,0.05);
}

body.dark-mode {
  --bg-color: #121212;
  --card-bg: #1e1e1e;
  --text-color: #f1f1f1;
  --border-color: #333;
  --shadow-color: rgba(255,255,255,0.05);
}

.container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

.top-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
}
.page-title {
  font-size: 2.3em;
  font-weight: 700;
}

/* ===========================================
   GRID + CARD DESIGN
=========================================== */
.posts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 25px;
}

.post-card {
  background-color: var(--card-bg);
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 6px 16px var(--shadow-color);
  transition: all 0.3s ease;
  display: flex;
  flex-direction: column;
}
.post-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

/* Thumbnail */
.post-thumbnail-container {
  height: 220px;
  overflow: hidden;
  position: relative;
}
.post-thumbnail {
  width: 100%;
  height: 100%;
  object-fit: cover;
  transition: transform 0.4s ease;
}
.post-card:hover .post-thumbnail {
  transform: scale(1.07);
}

/* üßë‚Äçüíª AUTHOR META */
.author-meta {
  position: absolute;
  bottom: 10px;
  left: 10px;
  background-color: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(6px);
  border-radius: 8px;
  padding: 6px 10px;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 0.9em;
  color: #444;
  transition: background 0.3s ease;
}

.author-meta:hover {
  background-color: rgba(255, 255, 255, 0.95);
}

.author-link {
  color: #007bff;
  font-weight: 600;
  text-decoration: none;
  transition: color 0.3s ease;
}

.author-link:hover {
  color: #0056b3;
  text-decoration: underline;
}

body.dark-mode .author-meta {
  background-color: rgba(30, 30, 30, 0.8);
}
body.dark-mode .author-link {
  color: #66b2ff;
}

/* Body */
.post-body {
  padding: 18px;
  flex: 1;
}
.post-title a {
  text-decoration: none;
  color: var(--text-color);
  font-size: 1.4em;
  font-weight: 600;
}
.post-date {
  color: #999;
  font-size: 0.9em;
  margin: 5px 0 10px 0;
}
.post-snippet {
  color: var(--text-color);
  opacity: 0.9;
  line-height: 1.6;
  flex: 1;
}

/* Buttons */
.post-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  margin-top: 10px;
}
.btn {
  text-decoration: none;
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 0.9em;
  cursor: pointer;
  border: none;
  transition: all 0.2s;
}
.read-btn {
  background-color: #007bff;
  color: #fff;
}
.read-btn:hover {
  background-color: #0056b3;
}
.edit-btn {
  background-color: #ffc107;
  color: #222;
}
.delete-btn {
  background-color: #dc3545;
  color: white;
}

/* Load More */
.load-more-container {
  text-align: center;
  margin-top: 30px;
}
.load-more-btn {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.3s;
}
.load-more-btn:hover {
  background-color: #0056b3;
  transform: scale(1.05);
}

/* Dark Mode Button */
.theme-btn {
  background: none;
  border: 2px solid var(--text-color);
  color: var(--text-color);
  border-radius: 8px;
  padding: 8px 14px;
  cursor: pointer;
  font-size: 0.9em;
  transition: all 0.3s;
}
.theme-btn:hover {
  background-color: var(--text-color);
  color: var(--bg-color);
}

/* Responsive */
@media (max-width: 768px) {
  .page-title {
    font-size: 1.8em;
  }
  .top-bar {
    flex-direction: column;
    gap: 15px;
  }
  .author-meta {
    font-size: 0.8em;
    padding: 5px 8px;
  }
}
</style>

<script>
// üåó Dark Mode Toggle
const themeToggle = document.getElementById('themeToggle');
themeToggle.addEventListener('click', () => {
  document.body.classList.toggle('dark-mode');
  themeToggle.textContent = document.body.classList.contains('dark-mode')
    ? '‚òÄÔ∏è Light Mode'
    : 'üåô Dark Mode';
});

// üîΩ Load More Button
const loadMoreBtn = document.getElementById('loadMoreBtn');
if (loadMoreBtn) {
  loadMoreBtn.addEventListener('click', () => {
    const hiddenPosts = document.querySelectorAll('.post-card[style*="display:none"]');
    const batch = Array.from(hiddenPosts).slice(0, 6);
    batch.forEach(post => {
      post.style.display = 'flex';
      post.style.animation = 'fadeIn 0.6s ease';
    });
    if (hiddenPosts.length <= 6) {
      loadMoreBtn.style.display = 'none';
    }
  });
}

// Fade-in animation
const style = document.createElement('style');
style.textContent = `
@keyframes fadeIn {
  from {opacity: 0; transform: translateY(20px);}
  to {opacity: 1; transform: translateY(0);}
}`;
document.head.appendChild(style);
</script>
